# MT-GBM設計方針

## 論文アルゴリズムの整理

論文「MT-GBM: A multi-task Gradient Boosting Machine with shared decision trees」に基づいて、MT-GBMの主要アルゴリズムを整理します。

### アルゴリズム1: MT-GBM全体の学習アルゴリズム

1. 初期予測値を設定（各タスクの平均値など）
2. 各ブースティング反復で:
   - 各タスクの勾配・ヘシアンを計算
   - アルゴリズム2を使用して共有決定木を構築
   - 予測値を更新

### アルゴリズム2: 共有決定木の構築

1. 各タスクの勾配・ヘシアンを計算
2. タスク間の相関行列を計算
3. メインタスクを選択または強調（重み付け）
4. 加重和された勾配・ヘシアンを使用して分割点を探索
5. 最適な分割点で左右の子ノードに分割
6. 再帰的に子ノードを構築
7. リーフノードではアルゴリズム3を使用して最適なリーフ値を計算

### アルゴリズム3: リーフ値の計算

1. 各タスクの勾配・ヘシアンの合計を計算
2. タスク間の相関を考慮した最適化問題を解く
3. 各タスクのリーフ値を同時に計算

## 現状コードの問題点

1. **共有決定木構造の不完全な実装**:
   - 分割点探索が単一の加重和された勾配・ヘシアンのみに基づいている
   - タスク間の相関が分割点探索に十分に活用されていない

2. **リーフ値計算の単純化**:
   - 各タスクのリーフ値が独立に計算されている
   - タスク間の相関を考慮した同時最適化が行われていない

3. **メインタスク強調の不明確さ**:
   - タスク重みの設定が単純なランダム反転に依存
   - 論文のγパラメータによるメインタスク強調が不十分

4. **アンサンブル管理の曖昧さ**:
   - 木の構築と予測値の更新が単純な加算に基づいている
   - タスク間の相関に基づく適応的な更新が不足

## リファクタリング設計方針

### 1. 共有決定木構造の改善

- **タスク間相関を考慮した分割点探索**:
  - 相関行列を使用して分割点の評価を改善
  - 各タスクの勾配・ヘシアンを個別に考慮しつつ、共有構造を維持

- **メインタスク強調メカニズムの明確化**:
  - γパラメータを導入して特定のタスクを強調
  - 適応的なタスク重み付けアルゴリズムの実装

### 2. リーフ値計算の改善

- **タスク間相関を考慮したリーフ値の同時最適化**:
  - 論文のアルゴリズム3に基づく最適化問題の解法
  - 正則化項の適切な設定

- **数値安定性の確保**:
  - 極端な値や特異ケースへの対応
  - 適切なクリッピングと正則化

### 3. アンサンブル管理の改善

- **適応的な学習率**:
  - タスク間の相関に基づく学習率の調整
  - 各タスクの収束速度の調整

- **予測値更新の改善**:
  - タスク間の相関を考慮した予測値の更新
  - 過学習防止のための正則化

### 4. コード構造の改善

- **クラス階層の明確化**:
  - 基底クラスと派生クラスの責任分担
  - インターフェースの一貫性

- **パラメータ設定の整理**:
  - 論文のパラメータとの対応関係の明確化
  - デフォルト値の適切な設定

- **ドキュメントとコメントの充実**:
  - 論文との対応関係の明示
  - アルゴリズムの各ステップの説明

## 実装上の重要ポイント

1. **タスク間相関行列の効果的な活用**:
   - 相関行列を使用して分割点探索と葉値計算を改善
   - 相関の強いタスク間での情報共有を促進

2. **メインタスク強調の適切な実装**:
   - γパラメータを使用して特定のタスクを強調
   - 各反復でのメインタスク選択戦略の明確化

3. **リーフ値の同時最適化**:
   - タスク間の相関を考慮した最適化問題の解法
   - 効率的な計算アルゴリズムの実装

4. **数値安定性と例外処理**:
   - ゼロ除算や極端な値への対応
   - エッジケースの適切な処理

5. **テスト可能性の確保**:
   - 各コンポーネントの単体テスト
   - エンドツーエンドのテストシナリオ
